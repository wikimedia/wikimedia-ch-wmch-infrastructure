<VirtualHost *:443>

	ServerName survey.wikimedia.ch

	DocumentRoot /var/www/wikimedia.ch/limesurvey/www

	# we are using PHP-FPM so let's disable PHP native's module
	<IfModule mod_php>
		php_admin_flag engine off
	</IfModule>

	# disable unused, slow, insecure features
	<Directory /var/www/wikimedia.ch/limesurvey/www>

		# include .htaccess manually (more quick)
		Include /var/www/wikimedia.ch/limesurvey/htaccess.txt

		# avoid listing stuff, avoid unuseful stuff
		Options -Indexes

		# disable unused and slow .htaccess feature
		AllowOverride none

		<FilesMatch \.php$>
			# a2enmod proxy_fcgi
			SetHandler "proxy:unix:/run/php/php7.3-fpm-limesurvey.sock|fcgi://localhost/"
		</FilesMatch>

	</Directory>

	# SSL certificates (do not break Apache at startup if the files are not existing)
	<IfFile /etc/letsencrypt/live/survey.wikimedia.ch/cert.pem>
		SSLEngine on

		# To deploy Let's Encrypt certificates:
		#   letsencrypt certonly -d survey.wikimedia.ch --webroot --webroot-path /var/www/wikimedia.ch/limesurvey/www
		SSLCertificateFile      /etc/letsencrypt/live/survey.wikimedia.ch/cert.pem
		SSLCertificateKeyFile   /etc/letsencrypt/live/survey.wikimedia.ch/privkey.pem
		SSLCertificateChainFile /etc/letsencrypt/live/survey.wikimedia.ch/chain.pem

		# certbot goodies
		Include /etc/letsencrypt/options-ssl-apache.conf
	</IfFile>

	ErrorLog  /var/log/apache2/wmch.limesurvey-err.log
	CustomLog /var/log/apache2/wmch.limesurvey-access.log combined

</VirtualHost>

# redirect unsecure traffic
<VirtualHost *:80>

	ServerName survey.wikimedia.ch

	Redirect permanent / https://survey.wikimedia.ch/

</VirtualHost>
